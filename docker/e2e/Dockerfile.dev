FROM mcr.microsoft.com/playwright:v1.52.0-focal

# Set working directory
WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies including wait-on for service readiness
RUN npm ci && npm install -g wait-on

# Copy source code
COPY . .

# Expose port for the app
EXPOSE 3000

# Create a script for development E2E testing
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
# Start the development server in background\n\
npm run dev &\n\
APP_PID=$!\n\
\n\
# Wait for the app to be ready\n\
echo "Waiting for development server to be ready..."\n\
wait-on http://localhost:3000 --timeout 60000\n\
\n\
# Run the E2E tests with Docker config\n\
npx playwright test --config=playwright.config.docker.ts\n\
\n\
# Clean up\n\
kill $APP_PID\n\
' > /app/run-e2e-dev.sh && chmod +x /app/run-e2e-dev.sh

# Default command for development
CMD ["./run-e2e-dev.sh"]